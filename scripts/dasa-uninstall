#!/usr/bin/env bash
set -euo pipefail

# dasa-uninstall â€” repo-local workflow removal

SCRIPT_NAME="dasa-uninstall"
VERSION="v1"

WORKFLOW_FILES=(
  "dasa-init.md"
  "dasa-plan.md"
  "dasa-start-work.md"
  "dasa-status.md"
  "dasa-uninstall.md"
)

ROOT=""
DRY_RUN="false"
FORCE="false"

log_err() {
  echo "${SCRIPT_NAME}: $*" >&2
}

usage() {
  cat <<'EOF'
Usage: dasa-uninstall [--dry-run] [--force] [--root <path>]

Flags:
  --help        Show this help and exit 0
  --dry-run     Print intended actions; perform no deletions
  --force       Required to perform deletions (safety)
  --root <path> Target root directory (default: current working directory)

Exit codes: 0=success, 1=user error, 2=system error
EOF
}

print_action() {
  echo "ACTION=${1} PATH=${2}"
}

detect_root() {
  if [ -n "$ROOT" ]; then
    if [ ! -d "$ROOT" ]; then
      log_err "--root path does not exist: $ROOT"
      exit 1
    fi
    echo "$ROOT"
    return 0
  fi

  pwd
}

parse_args() {
  while [ $# -gt 0 ]; do
    case "$1" in
      --help)
        usage
        exit 0
        ;;
      --dry-run)
        DRY_RUN="true"
        shift
        ;;
      --force)
        FORCE="true"
        shift
        ;;
      --root)
        if [ $# -lt 2 ]; then
          log_err "--root requires a path"
          exit 1
        fi
        ROOT="$2"
        shift 2
        ;;
      --*)
        log_err "unknown flag: $1"
        exit 1
        ;;
      *)
        log_err "unexpected argument: $1"
        exit 1
        ;;
    esac
  done
}

require_force_if_mutating() {
  if [ "$DRY_RUN" = "true" ]; then
    return 0
  fi
  if [ "$FORCE" = "false" ]; then
    echo "NOTICE=force_required"
    log_err "--force required for deletion"
    exit 1
  fi
}

remove_workflows() {
  local root="$1"
  local workflows_dir="$root/.agent/workflows"

  # Tolerate missing workflows dir.
  if [ ! -d "$workflows_dir" ]; then
    for wf in "${WORKFLOW_FILES[@]}"; do
      print_action "skip_missing" "$workflows_dir/$wf"
    done
    return 0
  fi

  for wf in "${WORKFLOW_FILES[@]}"; do
    local path="$workflows_dir/$wf"
    if [ -f "$path" ]; then
      if [ "$DRY_RUN" = "true" ]; then
        print_action "remove_file" "$path"
      else
        if rm -f -- "$path" 2>/dev/null; then
          print_action "remove_file" "$path"
        else
          log_err "failed to remove $path"
          exit 2
        fi
      fi
    else
      print_action "skip_missing" "$path"
    fi
  done
}

main() {
  parse_args "$@"

  local root
  root=$(detect_root) || exit 2

  require_force_if_mutating

  remove_workflows "$root"
}

main "$@"
