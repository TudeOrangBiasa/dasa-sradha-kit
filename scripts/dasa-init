#!/usr/bin/env bash
set -euo pipefail

# dasa-init â€” bootstrap per-repo Dasa Sradha scaffolding

SCRIPT_NAME="dasa-init"
VERSION="v1"

MASTER_WORKFLOWS_DIR="${HOME}/.gemini/scripts/dasa-sradha-kit/workflows"
WORKFLOW_FILES=(
  "dasa-init.md"
  "dasa-plan.md"
  "dasa-start-work.md"
  "dasa-status.md"
  "dasa-uninstall.md"
  "dasa-fix.md"
  "dasa-sync.md"
  "dasa-commit.md"
  "dasa-assimilate.md"
  "dasa-docs.md"
  "dasa-e2e.md"
  "dasa-seed.md"
  "dasa-pr.md"
)

ROOT=""
WALK_GIT_ROOT="false"
DRY_RUN="false"
FORCE="false"

log_err() {
  echo "${SCRIPT_NAME}: $*" >&2
}

usage() {
  cat <<'EOF'
Usage: dasa-init [--dry-run] [--force] [--root <path>] [--walk-git-root]

Flags:
  --help            Show this help and exit 0
  --dry-run         Print intended actions; perform no writes
  --force           Overwrite owned files if they already exist
  --root <path>     Target root directory (default: current working directory)
  --walk-git-root   Walk upward from PWD to nearest ancestor containing .git/; fallback to PWD

Exit codes: 0=success, 1=user error, 2=system error
EOF
}

print_action() {
  # Stable machine-readable line; human text may follow.
  echo "ACTION=${1} PATH=${2}"
}

ensure_dir() {
  local path="$1"
  if [ -d "$path" ]; then
    print_action "skip_existing" "$path"
    return 0
  fi
  if [ "$DRY_RUN" = "true" ]; then
    print_action "mkdir" "$path"
  else
    mkdir -p "$path" || { log_err "failed to create directory: $path"; exit 2; }
    print_action "mkdir" "$path"
  fi
}

copy_file() {
  local src="$1" dst="$2"
  if [ ! -f "$src" ]; then
    log_err "missing source template: $src"
    exit 2
  fi

  local existed="false"
  if [ -f "$dst" ]; then
    existed="true"
  fi

  if [ "$existed" = "true" ] && [ "$FORCE" = "false" ]; then
    print_action "skip_existing" "$dst"
    return 0
  fi

  if [ "$DRY_RUN" = "true" ]; then
    if [ "$existed" = "true" ]; then
      print_action "overwrite" "$dst"
    else
      print_action "create_file" "$dst"
    fi
    return 0
  fi

  if cp "$src" "$dst" 2>/dev/null; then
    if [ "$existed" = "true" ]; then
      print_action "overwrite" "$dst"
    else
      print_action "create_file" "$dst"
    fi
  else
    log_err "failed to copy to $dst"
    exit 2
  fi
}

create_marker() {
  local marker_path="$1/.dasa-sradha"
  local existed="false"
  if [ -f "$marker_path" ]; then
    existed="true"
  fi

  if [ "$existed" = "true" ] && [ "$FORCE" = "false" ]; then
    print_action "skip_existing" "$marker_path"
    return 0
  fi

  if [ "$DRY_RUN" = "true" ]; then
    if [ "$existed" = "true" ]; then
      print_action "overwrite" "$marker_path"
    else
      print_action "create_file" "$marker_path"
    fi
    return 0
  fi

  : >"$marker_path" || { log_err "failed to write marker"; exit 2; }
  if [ "$existed" = "true" ]; then
    print_action "overwrite" "$marker_path"
  else
    print_action "create_file" "$marker_path"
  fi
}

create_dasa_config() {
  local project_root="$1"
  local marker_dir="$project_root/.agent"
  local marker_path="$marker_dir/dasa.config.toon"
  local existed="false"

  if [ -f "$marker_path" ]; then
    existed="true"
  fi

  if [ "$existed" = "true" ] && [ "$FORCE" = "false" ]; then
    print_action "skip_existing" "$marker_path"
    return 0
  fi

  if [ "$DRY_RUN" = "true" ]; then
    if [ "$existed" = "true" ]; then
      print_action "overwrite" "$marker_path"
    else
      print_action "create_file" "$marker_path"
    fi
    return 0
  fi

  cat <<'EOF' > "$marker_path"
{
  "project": { "name": "App", "domain": "Web", "strict": true },
  "workspaces": { "frontend": "./", "backend": "./" },
  "stack": { "fe": ["HTML", "CSS", "JS"], "be": ["Node"], "db": [] },
  "skills": [],
  "rules": [
    "clean_code>clever",
    "strict_types=true",
    "no_hallucinations",
    "ui=component_based",
    "be=layered"
  ]
}
EOF
  if [ "$existed" = "true" ]; then
    print_action "overwrite" "$marker_path"
  else
    print_action "create_file" "$marker_path"
  fi
}

walk_git_root() {
  local start="$1" current="$1"
  while :; do
    if [ -d "$current/.git" ]; then
      echo "$current"
      return 0
    fi
    if [ "$current" = "/" ]; then
      echo "$start"
      return 0
    fi
    current=$(dirname "$current")
  done
}

detect_root() {
  if [ -n "$ROOT" ]; then
    if [ ! -d "$ROOT" ]; then
      log_err "--root path does not exist: $ROOT"
      exit 1
    fi
    echo "$ROOT"
    return 0
  fi

  local pwd
  pwd=$(pwd)
  if [ "$WALK_GIT_ROOT" = "true" ]; then
    walk_git_root "$pwd"
  else
    echo "$pwd"
  fi
}

print_gitignore_guidance() {
  cat <<'EOF'
ACTION=info PATH=.artifacts/
ACTION=info PATH=.agent/workflows/
ACTION=info PATH=.design-memory/mockups/

INFO=.artifacts/ contains evidence and plan outputs.
INFO=.design-memory/mockups/ contains raw PNG design files.
INFO=Add the above entries to .gitignore if not already ignored.
EOF
}

parse_args() {
  while [ $# -gt 0 ]; do
    case "$1" in
      --help)
        usage
        exit 0
        ;;
      --dry-run)
        DRY_RUN="true"
        shift
        ;;
      --force)
        FORCE="true"
        shift
        ;;
      --root)
        if [ $# -lt 2 ]; then
          log_err "--root requires a path"
          exit 1
        fi
        ROOT="$2"
        shift 2
        ;;
      --walk-git-root)
        WALK_GIT_ROOT="true"
        shift
        ;;
      --*)
        log_err "unknown flag: $1"
        exit 1
        ;;
      *)
        log_err "unexpected argument: $1"
        exit 1
        ;;
    esac
  done
}

main() {
  parse_args "$@"

  local root
  root=$(detect_root) || exit 2

  local workflows_dir="$root/.agent/workflows"
  local artifacts_dir="$root/.artifacts"
  local plans_dir="$root/.artifacts/plans"
  local design_dir="$root/.design-memory"
  local mockups_dir="$root/.design-memory/mockups"

  ensure_dir "$workflows_dir" || exit $?
  ensure_dir "$artifacts_dir" || exit $?
  ensure_dir "$plans_dir" || exit $?
  ensure_dir "$design_dir" || exit $?
  ensure_dir "$mockups_dir" || exit $?
  
  create_marker "$root" || exit $?
  create_dasa_config "$root" || exit $?

  for wf in "${WORKFLOW_FILES[@]}"; do
    local src="$MASTER_WORKFLOWS_DIR/$wf"
    local dst="$workflows_dir/$wf"
    copy_file "$src" "$dst"
  done

  # Process .gitignore logic
  local gitignore="$root/.gitignore"
  if [ "$DRY_RUN" != "true" ]; then
    if ! grep -q "^/.artifacts/" "$gitignore" 2>/dev/null; then
      echo "/.artifacts/" >> "$gitignore"
      print_action "create_file" "Added /.artifacts/ to .gitignore"
    else
      print_action "skip_existing" "Already found /.artifacts/ in .gitignore"
    fi
    if ! grep -q "^/.design-memory/mockups/" "$gitignore" 2>/dev/null; then
      echo "/.design-memory/mockups/" >> "$gitignore"
      print_action "create_file" "Added /.design-memory/mockups/ to .gitignore"
    else
      print_action "skip_existing" "Already found /.design-memory/mockups/ in .gitignore"
    fi
  else
    print_action "create_file" "Would add /.artifacts/ and /.design-memory/mockups/ to .gitignore"
  fi
  print_gitignore_guidance
}

main "$@"
