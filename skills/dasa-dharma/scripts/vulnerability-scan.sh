#!/bin/bash

# vulnerability-scan.sh
# Native execution script for Dasa Dharma (The Guardian)
# Performs a fast, static regex scan for hardcoded secrets, dangerous functions, and common vulnerabilities.

echo "[Dharma Guardian] Commencing static vulnerability scan..."

TARGET_DIR="${1:-.}"

# Find hardcoded secrets (AWS keys, generic tokens)
echo "-----------------------------------"
echo "üîç Checking for Hardcoded Secrets..."
grep -rIE --color=always "(A3T[A-Z0-9]|AKIA|AGPA|AIDA|AROA|AIPA|ANPA|ANVA|ASIA)[A-Z0-9]{16}|bearer [a-zA-Z0-9_\-\.]{128,}" "$TARGET_DIR" \
    --exclude-dir="node_modules" --exclude-dir=".git" --exclude-dir="dist" || echo "‚úÖ No obvious secrets found."

# Find dangerous functions (eval, exec, dangerouslySetInnerHTML)
echo "-----------------------------------"
echo "‚ö†Ô∏è Checking for Dangerous Sinks..."
grep -rIE --color=always "eval\(|exec\(|dangerouslySetInnerHTML|innerHTML[ ]*=" "$TARGET_DIR" \
    --exclude-dir="node_modules" --exclude-dir=".git" --exclude-dir="dist" || echo "‚úÖ No dangerous sinks found."

# Check for outdated dependencies (Node specific fallback)
echo "-----------------------------------"
echo "üì¶ Checking Dependencies..."
if [ -f "$TARGET_DIR/package.json" ]; then
    echo "Running npm audit (dry run fallback)..."
    npm audit --audit-level=high 2>/dev/null || echo "‚ö†Ô∏è Audit returned findings or npm not available."
else
    echo "No package.json found. Skipping npm audit."
fi

echo "-----------------------------------"
echo "[Dharma Guardian] Scan complete."
